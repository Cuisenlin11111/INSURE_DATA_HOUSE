# import sys
# sys.path.append(r"E:\pycharm\database")
from database import DatabaseConnection
from datetime import datetime, date, timedelta
# from emailSender import EmailSender
from EmailSender_New import EmailSender_New
from dateutil.relativedelta import relativedelta
today = date.today()
# 计算7天前的日期
formatted_date = today.strftime("%Y%m%d")
seven_days_ago = today - timedelta(days=7)
# 计算昨天的日期
yesterday = today - timedelta(days=1)





sql_query = f"""
  -- @description: 本部补医报销服务监管统计表
  -- @param:
  -- @return:
  -- @alter:
  -- @time: 2024-09-13 
  -- @author: 01
  -- @version: 1.0.0


select
    alr.ACCEPT_DATE as 交单日期,
    alr.ACCEPT_NUM as 受理编号,
    case when alr.claim_source in ( '1','3')  then '线下'
         when  alr.claim_source in ( '2','4')  then '线上'  else ''  end  交单类型,
    cpc.insured_name   姓名,
    cpc.insured_id_no 身份证号,
    GROUP_CONCAT( DISTINCT tk.报销类型 ) AS  报销类别,
   cai.N_INVOICE_SUM  发票总金额,
   cai.N_FINAL_COMPENSATE_AMT  报销总金额,
   cai.N_DEDUCT_AMT 扣减金额,
   count(distinct  inv.C_INV_NO) 票据张数,
   pr.back_time  支付日期,
   case when cai.N_DEDUCT_AMT > 0  then '是'  else '否'  end 是否退单,
   sum( if(inv.C_COMPENSATE_RESULT = '4', inv.N_DEDUCT_AMT, 0) )  退单金额,
    GROUP_CONCAT(distinct if(inv.C_COMPENSATE_RESULT = '4',CONCAT(inv.C_INV_NO, inv.C_INTERNAL_CONCLUSION,';'), ''))  退单原因,
    temp.是否明细拒付,
    temp.未退单但不予报销金额,
    temp.明细拒付原因
FROM
  claim_ods.claim c
  inner join     claim_ods.postback_record pr  on c.claim_no=pr.app_no and pr.receiver = 'S' and pr.is_deleted = 'N' AND pr.insure_company_channel = 'TK02'
  INNER JOIN claim_ods.accept_list_record alr on alr.ACCEPT_NUM = c.acceptance_no and alr.del_flag = '0' AND alr.insure_company_channel = 'TK02'
  INNER JOIN claim_ods.clm_app_info cai on cai.C_CUSTOM_APP_NO = c.claim_no and cai.c_del_flag = '0' AND cai.INSURANCE_COMPANY = 'TK02'
  LEFT JOIN (
  SELECT t.app_no,t.bill_no,case t.reimburse_type when '1' then '门诊报销' when '2' then '门诊规定病种' when '3' then '普通住院' when '4' then '重疾住院' when '5' then '重疾门诊规定病种' when '6' then '管委会报销' when '7' then '全额报销' else '未知' end 报销类型,gmt_created
  FROM claim_ods.tk_electric_bill_reimburse t WHERE t.is_deleted = 'N'
  GROUP BY t.app_no,t.bill_no,t.reimburse_type
   ) tk ON tk.app_no = c.claim_no
 left join claim_ods.`clm_visit_inv_info` inv on  c.claim_no = inv.C_CUSTOM_APP_NO and tk.bill_no = inv.C_INV_NO and inv.C_DEL_FLAG = '0'   AND inv.INSURANCE_COMPANY = 'TK02'
  INNER JOIN claim_ods.claim_policy cp on cp.policy_no = cai.C_PLY_NO
  INNER JOIN claim_ods.claim_policy_customer cpc on cpc.customer_no = cp.customer_no
  left JOIN (
    select  ct.C_CUSTOM_APP_NO,
    case when max(ct.C_COMPENSATE_RESULT) = '4'  then '是'  else '否'  end 是否明细拒付,
    sum(if(ct.C_COMPENSATE_RESULT = '4',ct.N_DEDUCT_AMT,0)) 未退单但不予报销金额,
    GROUP_CONCAT(distinct if(ct.C_COMPENSATE_RESULT = '4',CONCAT(ct.C_INV_NO, ct.C_INTERNAL_CONCLUSION,';'),''))    明细拒付原因
    from
    claim_ods.clm_treatment ct
    INNER JOIN claim_ods.claim_policy cp1 on cp1.policy_no = ct.C_PLY_NO
    INNER JOIN claim_ods.claim_policy_customer cpc1 on cpc1.customer_no = cp1.customer_no

    where
     ct.c_del_flag = '0' AND ct.INSURANCE_COMPANY = 'TK02'
     and cpc1.insured_id_no in ('370827198408270017',
'370102197303213315',
'370704197810030017',
'370684197602015222',
'370827198011170018',
'37060219820503231X',
'372425197907038610',
'370828198403282912',
'372802197108100518',
'370102197207093317',
'370102196803063312',
'370103197912120516',
'210106198207176118',
'370103198106260519',
'370102197207165835',
'370102196510223394',
'370104198201143712',
'372901198102071617',
'370102197506270010',
'372401197908242217',
'371323198102022852',
'370602198104065542',
'370103198001262518',
'370105197002243392',
'370103198207161018',
'370919197311120144',
'370103197901181524',
'430103197607181044',
'370983198509010552',
'510102196602128470',
'370102196605283330',
'370105196708122117',
'110108197511126072',
'372422196910240015',
'371082197704156320',
'370125198103240051',
'370103197811011548',
'370322197408204219',
'370102198111133331',
'370102197007123331',
'370802196612121856',
'371122198001170656',
'370882198108011210',
'370802197009050314',
'37082719840206137X',
'370830198601100114',
'37080219690701031X',
'370802198007053647',
'370802198008200311',
'420983198610130019',
'37080219790825031X',
'370103197010206011',
'37062919710722003X',
'310104196710050493',
'370687197912272872',
'370682198310145617',
'370102197007083325',
'371427198102201317',
'37242119761101223X',
'372401197610266451',
'372325196510260037',
'370902197005070014',
'370902197504180031',
'37152419861006305X',
'370102196905123339',
'372401197808180012',
'370502198207176469',
'370683198105201532',
'370911198401016053',
'370983198309160513',
'370919197208090354',
'370102198105070610',
'370123198102136217',
'370983198606170013',
'370922197105170026',
'370902197509041815',
'330106196903300459',
'371302198402141413',
'320102197003252831',
'37040219830312062X',
'370402196610131215',
'370702196508170337',
'370828198301134716',
'371302198607211614',
'370112198610117726',
'370285197411074734',
'210181198310051516',
'370421197010025316',
'370481198512180018',
'371302198403240210',
'370404198105200023',
'320621197101142456',
'371121198305170034',
'330106196802270414',
'220204197309012739',
'370102196512283390',
'372501197206051139',
'372501197710061192',
'372501198407131527',
'372501197703292013',
'372501197209271145',
'371326198309020052',
'372501197009290333',
'370102197910293329',
'372501197810280392',
'370102198002213359',
'372501198109062412',
'370982198603217713',
'370685198110013010',
'370102198401250616',
'370902197802280030',
'371202198507242610',
'371202198507226311',
'370920197202201311',
'370724198701026553',
'37018119780608301X',
'371321198201225310',
'370102196706273393',
'370103198304261053',
'370103198103220538',
'630105198506091327',
'370811198007061838',
'370828198205310310',
'370103198407088521',
'370882198208296137',
'372330197910210106',
'370102197912312116',
'370112198110307451',
'371002198207240516',
'370102197911223314',
'370102197810304131',
'370683198208081510',
'371324198201290058',
'511222198107046874',
'37240119761216271X',
'370122197701172753',
'370102198509254117',
'370103198302191514',
'370502197907113253',
'370103198309031011',
'370103198305015014',
'370829198110200027',
'370522197111101594',
'37142619840227161X',
'37083119820102071X',
'620103198512240013',
'371302198405311027',
'371321198410258514',
'370983198012102371',
'371202198108301513',
'370102196612143336',
'370181198301052116',
'37010219660430331X',
'372301198009100716',
'37010219710508337X',
'370683198205161216',
'210302197711250613',
'370303196610040015',
'370303197208237017',
'370321197912283933',
'37030319740710134X',
'370306197910171512',
'372328197207150074',
'372321198303110259',
'372801196709231619',
'372801196910114019',
'370102196710113413',
'370121196912287736',
'23082219800422031X',
'372801197002261050',
'372801196903032154',
'370830198105250834',
'370283197909272639',
'372831197512080039',
'370102197008243351',
'371203198204043514',
'371302198503261617',
'220722198507271234',
'371329198602156011',
'130603197106040936',
'37011119651016209X',
'372901197512091413',
'372901198106291211',
'370102197001173311',
'37100219821218052X',
'370112198002087471',
'370681197709115224',
'37072319700620357X',
'370729198001160219',
'370724197403300011',
'370724197906087793',
'370683197811263218',
'370202197711085442',
'37292919840128001X',
'371122198504230024',
'370303197701271729',
'370703197111083711',
'370702197812183946',
'370727198110271812',
'310110196507190439',
'37282419700906621X',
'371102197503087537',
'370212197609116030',
'370102196903013371',
'370281198110072611',
'372802197109281613',
'372901198102101230',
'371102197804093519',
'370704196512210218',
'372325198708060830',
'37068219870123641X',
'420682198610262035',
'371402198510071219',
'37132219881119751X',
'142323198607080239',
'612323198610105014',
'37120219861105031X',
'372324198610220035',
'371502198409042013',
'371502198501247812',
'371524198712133012',
'362402198803140010',
'371324198810092436',
'132201198410036618',
'370102198701214123',
'220204198704302714',
'370902198310202137',
'370103198304081570',
'370102197508313328',
'370102196507033338',
'370103197303304109',
'370902196605210012',
'372901197809143413',
'370111196506071013',
'370402197709187846',
'372922196910227715',
'110105196911094133',
'370902197006010072',
'370103197103126045',
'370121197507057712',
'370112197110267715',
'372929197007020047',
'370823197006051110',
'370102197409263759',
'370523197504150334',
'130603196506150910',
'370102196508253332',
'110108196504019039',
'37243019731029302X',
'37072419740113032X',
'37250119740426117X',
'372925197012113111',
'372425196910229413',
'42010619651019487X',
'370302196902260515',
'37010519621022233X',
'370102196502071327',
'370123197403290029',
'370111196603191076',
'370102196510273391',
'372926197710144835',
'43010319670418105X',
'370121197602157586',
'370103197402010018',
'372802197104120052',
'370102196908042972',
'37010519681226211X',
'370102196710203339',
'370920197004290034',
'370105197012143328',
'230103197106110312',
'430103197011241114',
'372801197303071218',
'370102196603203317',
'370102197511200017',
'370823197403250017',
'370723197304173110',
'372401196710282219',
'370103197412233514',
'31011019650905043X',
'370102196512293310',
'320102196801242895',
'370104197009100013',
'370102197012193318',
'372832197501270028',
'370103197202039334',
'370102197206063327',
'370303196904041734',
'372801196912112113',
'370103197903091514',
'370682198004040462',
'220204196809042155',
'370105197212123743',
'370102196805013335',
'370121197209181520',
'370103197108112523',
'222301197407271513',
'372421197010300068',
'370103197409035015',
'370103196505040514',
'370103196610120532',
'370102197404162510',
'379002197411032215',
'370102197409243352',
'372321197902188950',
'370303197903182513',
'370722197902236410',
'370112198211217412',
'370102197007130312',
'370627197408230212',
'61010319740216245X',
'310112196809300077',
'370105197201083731',
'370103196607070511',
'370102197010303317',
'370102197104222518',
'370303197404102515',
'370302198512155129',
'372432198812055010',
'370402198505291013',
'370103198708221023',
'370125198802130011',
'370681198801252250',
'152123198904204323',
'370902198703261824',
'371082198701230710',
'37040219851124191X',
'370323198710080211',
'371502198607101133',
'370103198801171542',
'372325198703290047',
'370102198005213311',
'371202198110247114',
'370103198610270513',
'230103198010020325',
'371121198610012315',
'370784198809010330',
'370102198103084525',
'412725198806267012',
'320623198806148097',
'320321198806094210',
'371425198112040032',
'41122219850329151X',
'150426197402120030',
'371322198002270553',
'370105198211131113',
'370829198810053590',
'370982198904294392',
'372526198004175338',
'371082198205044919',
'130402198508140013',
'37010319700420401X',
'370104197812210713',
'370282197910300047',
'370303196503070016',
'370102196507243319',
'370102196506243376',
'37010519711206001X',
'370105197406192122',
'370102197908073319',
'652801198105256117',
'370105197901071715',
'370102196912062538',
'371202198501167429',
'370104196406260358',
'370104197603112922',
'37010419721024035X',
'370102196607293313',
'37142519811118013X',
'370622197212051413',
'370783197901163590',
'370902198111251518',
'372425197903062074',
'610522197905078015',
'371302198101260419',
'370602198201162926',
'370725198712080236',
'37088319861102623X',
'370921198603041516',
'370784198310078213',
'372929198602170634',
'371327198808200230',
'371425198708205571',
'131102198603070230',
'320324198508140011',
'370126198809010094',
'370783198404230371',
'371082198803207730',
'370303198809240048',
'370724198609231853',
'370782198410162030',
'370982198509100631',
'370303198303251313',
'370686198504291714',
'37078319830711597X',
'370304198811240617',
'370602198903021343',
'370123198410064710',
'370882198705171212',
'371402198303082644',
'370285198110110011',
'370983198612013276',
'411422198712084219',
'150402198908062310',
'370502198507206033',
'430903198902081546',
'370104198410230310',
'371102198406195418',
'34262319870826687X',
'371102198710260616',
'371122198906281537',
'370781199001218214',
'370103198807024017',
'370781198110084839',
'370983198705141015',
'370782198501047214',
'370111197008182014',
'370111196708252058',
'370125196705170055',
'370102198509164111',
'370283198606067018',
'371322198607290012',
'371302198705253738',
'371327198301034317',
'370828199002107034',
'370802198801083616',
'370786198806105118',
'37142519890914009X',
'371482198507110346',
'371426198701292015',
'370104198804032624',
'371522198801215754',
'371524198803164914',
'370982198803131818',
'370522198201280033',
'371322199005240573',
'370683198010290034',
'370481198803132614',
'370883198904045354',
'370104196910120311',
'370982198711254976',
'370802198705023314',
'370802198905253624',
'371502199103242017',
'371426198807165639',
'37090219821027001X',
'370811198701100040',
'370786198812295413',
'371322199009140422',
'370703198802170536',
'371502199006102039',
'371321199007187933',
'370921198509133334',
'370402199003060033',
'372926198807053950',
'372324198512224120',
'370103198907201527',
'370682198709138611',
'239005198909294653',
'371402198611075737',
'370724198903052055',
'370685198611052210',
'370983199002250017',
'370921198608014234',
'370102198611150330',
'372930198802295998',
'370983198612271814',
'370285198705032913',
'370611198604010341',
'371526198602182836',
'37131119900505443X',
'371326198411234321',
'371327198604236418',
'370303198902165185',
'371002199010117017',
'370725198506113279',
'37150219870903033X',
'370104198705054529',
'371422198711200078',
'22060319880320033X',
'371328198603190071',
'370685198801060043',
'412828199002150037',
'370829198201154230',
'370783198308172319',
'410882199009201024',
'370103198909247529',
'372930198910135158',
'372928198702121067',
'370683198211177214',
'372330198111160055',
'370783198208202912',
'360102197312195823',
'410922199010101329',
'37078119940414052X',
'371328199106182534',
'370283199010124530',
'370902199012240922',
'371202198902184019',
'370683199003319235',
'370102198803093318',
'371121198911202315',
'370602199101155213',
'370322199010266718',
'220381199203160263',
'372928199010220018',
'371327199109084124',
'372301199109130722',
'130429199012172657',
'370782199204021151',
'370983199108151834',
'370523199107100017',
'370103199001010534',
'370104199302271320',
'371323199104107619',
'37142819920626054X',
'370404199202271418',
'371427199204265519',
'37132419920401941X',
'370705199201110519',
'370102199012174116',
'430423197403239015',
'370102196503283452',
'370481199106170636',
'142126197210054239',
'622425197410160313',
'330106197010120455',
'430626197207234831',
'370202199404061423',
'370827198809103519',
'371102199006087519',
'370785198512270912',
'37152219881119001X',
'370911198902232504',
'371523198411160096',
'371323198812250817',
'370982198903140658',
'370983198809187069',
'130429198705101216',
'500101198603161011',
'422822198707301017',
'37032319870813345X',
'370783198807202762',
'370102199012184146',
'372301199002060031',
'370828198612044021',
'370881198806135310',
'372301198801170021',
'130430198612031912',
'13068119870724361X',
'370126198911090414',
'370685198901266516',
'640202199105160013',
'371002199009208851',
'371323198808292133',
'370402199306287729',
'370921199003133614',
'610527198910033280',
'410782198910082793',
'371481198804027534',
'371311198902102337',
'370828198802262337',
'370522198605151318',
'370725199111120217',
'372323198904282112',
'370724199204157661',
'350481198910274016',
'370103198904054015',
'370103198810152511',
'370403198902065614',
'371102199104050031',
'372922199004210018',
'370781199011143631',
'370982198905227693',
'370724198811263912',
'370784198901158610',
'370830199012127217',
'371422199211161943',
'370724199211251410',
'370782198908108218',
'370724198705196146',
'370634198909010021',
'370685199002204017',
'371402199304271927',
'37148219900211141X',
'370104198905200316',
'370983199108252328',
'511623198910180536',
'370785199109200919',
'370781199005020520',
'370523199003040312',
'370302199310096911',
'370724198806070390',
'430725199006056010',
'370282198912281518',
'140104197112251618',
'310112197206290070',
'370102196706063310',
'371321199710098510',
'371102199511075711',
'370103195707190516',
'370402195803091016',
'370421196301030639',
'370602195312312313',
'370211195902140026',
'371424196204160036',
'372501196305270711',
'370502195502031234',
'372901195801111215',
'372901195704110835',
'37090219641202001X',
'370802196208100332',
'372401196211052734',
'370303196412191015',
'372901196301030835',
'370602196001220221',
'370702196401240315',
'370302196312030533',
'37011119630216105X',
'370111195904301035',
'370104196402291616',
'370902196305271833',
'370103196312060551',
'370304195801071318',
'370111195711011613',
'370102195310182917',
'372801195610231024',
'370102196908171328',
'370121195710087715',
'370102195412220822',
'370102195309080817',
'370111196408101047',
'370103196402040511',
'370102196208161348',
'370102196006081315',
'370104196410060359',
'370421195111080913',
'370102196007110026',
'370104196401170345',
'370103195305140532',
'370103196203250516',
'370111196203011013',
'37010319571225051X',
'370802195503142418',
'370721195907100779',
'370104196409031614',
'372901195601040811',
'370103195808080519',
'370103195109040534',
'370104195907150312',
'370102195705201916',
'37280119610319231X',
'370111195205124439',
'370103195111280510',
'370111195211141016',
'370111196301211676',
'370102196006011317',
'370104195512260330',
'370111195709071094',
'370103195409292012',
'370103196301030533',
'370104195507232917',
'372801195509021217',
'110108196205152796',
'372801196208201219',
'370111196411162019',
'370103195607134031',
'370111196308281036',
'370111196310251047',
'370102196906213328',
'370502195506141211',
'370103195012130517',
'370802195110070310',
'370103196304120526',
'370111195012031615',
'370402196411251222',
'370111195509081028',
'370103195509212542',
'370704196405130247',
'370104195206020312',
'370105195201113313',
'370103196812094045',
'370111195010032315',
'370103195511063515',
'370103196308230538',
'370102196203282917',
'370104195511110314',
'370104196808181644',
'370111196410111033',
'370902196103031233',
'370121196508107713',
'370103196210200517',
'370111195307181098',
'37011119640720161X',
'370104196301011611',
'370111196012061034',
'37280119640911121X',
'370103195207171036',
'37012119531101771X',
'372801194912011217',
'370111195802191664',
'370121196407037728',
'370111196107121036',
'370522196005022310',
'370825196408065337',
'370104196504161927',
'370705195010133015',
'370111196203061010',
'370632195609250019',
'370902195107191512',
'372801195010061236',
'370825196404215334',
'372802196412230013',
'310110196812130440',
'370105195301072117',
'370704195110120215',
'370104196204280342',
'370103195201060538',
'370102196304293391',
'370103196403070536',
'230103196409140637',
'37010319641016053X',
'370103196211210530',
'370111196410041039',
'370102195906302940',
'370103195112180511',
'370103196408280516',
'370103196206200514',
'370103196212060570',
'37010319630428351X',
'370102196912060620',
'370103196303140517',
'370103196104170510',
'370103196312090515',
'370103195411151032',
'370104196303312215',
'370102196407011318',
'370103196301040619',
'370103195407310512',
'370103195312050535',
'370103196208180510',
'370922196402152313',
'370104196901102621',
'370922195507152331',
'370104195804302918',
'370103196211144035',
'370102196312131325',
'370702196312120311',
'370303195603140013',
'370103196310160516',
'372801195507080010',
'370104196307280353',
'372801195705260418',
'37010319590530051X',
'370202196203255412',
'372801196404071212',
'370919195910132914',
'370802196612291521',
'370902196112211818',
'370402196007052512',
'370105196201093310',
'372301196302130333',
'370602196409282952',
'370103196301100511',
'372801196406171217',
'370104196308161639',
'370102196412053395',
'371327196609180012',
'370104196308280312',
'370103196310250538',
'370402195507252516',
'37030419570228131X',
'370111196202081028',
'370104195707012636',
'370402195809101211',
'370303195104133118',
'370103194412251516',
'370825194610195312',
'370502195510031226',
'370103195508130561',
'370103196310080540',
'370111195307104439',
'370102194906192935',
'370103195302250517',
'370103195302102012',
'370111194904281017',
'370111195512161627',
'370104193707021613',
'37011119350906101X',
'370103195302285517',
'370181193603132135',
'370802195602180321',
'370103193505260521',
'370103195402250522',
'370802194907151818',
'370103195403174023',
'370103195408120526',
'370103195312190562',
'370103194811260516',
'370104195309111620',
'370111194812271014',
'370111194808251010',
'370104194810112956',
'370104194806081018',
'370103195307304027',
'370103195305120523',
'370922195309112320',
'370102194809180334',
'370103194701312039',
'370305194705161817',
'370103195111200541',
'370111195209301025',
'370103194703070539',
'370103194712100533',
'370103194702160014',
'370802194705020318',
'370105194709180010',
'370105194606052112',
'370103195302274527',
'370104195303081627',
'370103195302020543',
'370104194512250314',
'372301195211140320',
'370702194508210336',
'37020219470621391X',
'370103195207130568',
'370104194707032915',
'370729194704080014',
'370102194910270617',
'370103195201170526',
'370105195202022122',
'370103195201180521',
'370802194703222119',
'370104194708250316',
'370111194706121012',
'370111194706291011',
'370402194512191012',
'37011119460507101X',
'370402194607291016',
'370104194310251319',
'370105194602092117',
'370103195101220522',
'370103194601270513',
'370103194602030511',
'370103194608140519',
'370111194611244415',
'370103194611110513',
'370103195111150548',
'372801194408200414',
'370104194612090012',
'37011119441001105X',
'370103194505210510',
'370104194608242618',
'370103194503151510',
'370105194507122111',
'370105194509232111',
'370104194505220352',
'370103194510300019',
'370922194410112312',
'370104194907262926',
'370103194404170011',
'370103194910020526',
'370421194211230611',
'370104194208071610',
'370111194305201011',
'370103194308162513',
'370105194302140017',
'370105194212112135',
'370104194807291623',
'370704194210190216',
'370103193312040514',
'370103193208261034',
'370111194504241024',
'370104193710032911',
'370103193512201028',
'370103193911020523',
'370102193906133324',
'370103193812100536',
'370103193709240514',
'370702193907310022',
'370103193703041020',
'370103194307301526',
'37010319380914401X',
'370111193909291033',
'370111193711101038',
'370103193508190522',
'370103193312070510',
'370802194312151827',
'370103193102110529',
'370103193509010511',
'370103193603021532',
'370103193310210516',
'370102193606162529',
'370103193106160515',
'370104193904082933',
'370802193408211826',
'370103193610180515',
'370103193404260514',
'370104194009251619',
'370205193310015540',
'370103193611070529',
'370104193804261619',
'370104193502161612',
'370103193709260515',
'370103193111170523',
'370103193806170538',
'370104193707151610',
'370103194011060532',
'370103193911100515',
'370103194009230512',
'370103193901280516',
'370103193811120527',
'370104193508231618',
'370103193409290528',
'370105194002251129',
'370111193612161019',
'370105193503192118',
'370103193911260017',
'370103194004270523',
'370103193904120518',
'370103193801260518',
'370103193701200526',
'370802194511221824',
'370103193708220511',
'370103194510190526',
'370103194012220518',
'370111193808251032',
'37010319361125052X',
'370103194011101015',
'370102193011101129',
'370102193512180814',
'37010219390710295X',
'370103193808161010',
'37010319370626051X',
'370103194106094022',
'370103194212110532',
'370103194207200517',
'370103194204301013',
'370103194110150517',
'370103194110100536',
'370103194709290524',
'370103194512180516',
'370103194505040515',
'370103194112222019',
'370103193208081519',
'370103195711160520',
'370104194203211629',
'370104194107012910',
'370104194612021623',
'370111193206291010',
'370702194701140341',
'370121195106057720',
'370111195701234442',
'370111195606034426',
'370111194102034436',
'370111194003024419',
'370111194410151036',
'370802194407251812',
'370105194007132110',
'370103195211030519',
'370103195308241531',
'370104194905222912',
'370103195810090521',
'370802194810191813',
'370111194902011611',
'370103195403080529',
'37010419481006291X',
'370102195404130624',
'370102194601202549',
'370102195806110618',
'370103195407234513',
'372801195809271218',
'370103195409228010',
'37011119541004231X',
'370111195502201031',
'370825196007205327',
'372801196012260428',
'370825195203185314',
'370111195812111015',
'370111196311041017'
)
     group by ct.C_CUSTOM_APP_NO
  ) temp on c.claim_no = temp.C_CUSTOM_APP_NO
where  alr.INSURE_COMPANY_CHANNEL='TK02'
  and  substr(pr.back_time ,1,10)>='{seven_days_ago}'
  and  substr(pr.back_time ,1,10)<='{yesterday}'
  and pr.id is  not  null
and cpc.insured_id_no in ('370827198408270017',
'370102197303213315',
'370704197810030017',
'370684197602015222',
'370827198011170018',
'37060219820503231X',
'372425197907038610',
'370828198403282912',
'372802197108100518',
'370102197207093317',
'370102196803063312',
'370103197912120516',
'210106198207176118',
'370103198106260519',
'370102197207165835',
'370102196510223394',
'370104198201143712',
'372901198102071617',
'370102197506270010',
'372401197908242217',
'371323198102022852',
'370602198104065542',
'370103198001262518',
'370105197002243392',
'370103198207161018',
'370919197311120144',
'370103197901181524',
'430103197607181044',
'370983198509010552',
'510102196602128470',
'370102196605283330',
'370105196708122117',
'110108197511126072',
'372422196910240015',
'371082197704156320',
'370125198103240051',
'370103197811011548',
'370322197408204219',
'370102198111133331',
'370102197007123331',
'370802196612121856',
'371122198001170656',
'370882198108011210',
'370802197009050314',
'37082719840206137X',
'370830198601100114',
'37080219690701031X',
'370802198007053647',
'370802198008200311',
'420983198610130019',
'37080219790825031X',
'370103197010206011',
'37062919710722003X',
'310104196710050493',
'370687197912272872',
'370682198310145617',
'370102197007083325',
'371427198102201317',
'37242119761101223X',
'372401197610266451',
'372325196510260037',
'370902197005070014',
'370902197504180031',
'37152419861006305X',
'370102196905123339',
'372401197808180012',
'370502198207176469',
'370683198105201532',
'370911198401016053',
'370983198309160513',
'370919197208090354',
'370102198105070610',
'370123198102136217',
'370983198606170013',
'370922197105170026',
'370902197509041815',
'330106196903300459',
'371302198402141413',
'320102197003252831',
'37040219830312062X',
'370402196610131215',
'370702196508170337',
'370828198301134716',
'371302198607211614',
'370112198610117726',
'370285197411074734',
'210181198310051516',
'370421197010025316',
'370481198512180018',
'371302198403240210',
'370404198105200023',
'320621197101142456',
'371121198305170034',
'330106196802270414',
'220204197309012739',
'370102196512283390',
'372501197206051139',
'372501197710061192',
'372501198407131527',
'372501197703292013',
'372501197209271145',
'371326198309020052',
'372501197009290333',
'370102197910293329',
'372501197810280392',
'370102198002213359',
'372501198109062412',
'370982198603217713',
'370685198110013010',
'370102198401250616',
'370902197802280030',
'371202198507242610',
'371202198507226311',
'370920197202201311',
'370724198701026553',
'37018119780608301X',
'371321198201225310',
'370102196706273393',
'370103198304261053',
'370103198103220538',
'630105198506091327',
'370811198007061838',
'370828198205310310',
'370103198407088521',
'370882198208296137',
'372330197910210106',
'370102197912312116',
'370112198110307451',
'371002198207240516',
'370102197911223314',
'370102197810304131',
'370683198208081510',
'371324198201290058',
'511222198107046874',
'37240119761216271X',
'370122197701172753',
'370102198509254117',
'370103198302191514',
'370502197907113253',
'370103198309031011',
'370103198305015014',
'370829198110200027',
'370522197111101594',
'37142619840227161X',
'37083119820102071X',
'620103198512240013',
'371302198405311027',
'371321198410258514',
'370983198012102371',
'371202198108301513',
'370102196612143336',
'370181198301052116',
'37010219660430331X',
'372301198009100716',
'37010219710508337X',
'370683198205161216',
'210302197711250613',
'370303196610040015',
'370303197208237017',
'370321197912283933',
'37030319740710134X',
'370306197910171512',
'372328197207150074',
'372321198303110259',
'372801196709231619',
'372801196910114019',
'370102196710113413',
'370121196912287736',
'23082219800422031X',
'372801197002261050',
'372801196903032154',
'370830198105250834',
'370283197909272639',
'372831197512080039',
'370102197008243351',
'371203198204043514',
'371302198503261617',
'220722198507271234',
'371329198602156011',
'130603197106040936',
'37011119651016209X',
'372901197512091413',
'372901198106291211',
'370102197001173311',
'37100219821218052X',
'370112198002087471',
'370681197709115224',
'37072319700620357X',
'370729198001160219',
'370724197403300011',
'370724197906087793',
'370683197811263218',
'370202197711085442',
'37292919840128001X',
'371122198504230024',
'370303197701271729',
'370703197111083711',
'370702197812183946',
'370727198110271812',
'310110196507190439',
'37282419700906621X',
'371102197503087537',
'370212197609116030',
'370102196903013371',
'370281198110072611',
'372802197109281613',
'372901198102101230',
'371102197804093519',
'370704196512210218',
'372325198708060830',
'37068219870123641X',
'420682198610262035',
'371402198510071219',
'37132219881119751X',
'142323198607080239',
'612323198610105014',
'37120219861105031X',
'372324198610220035',
'371502198409042013',
'371502198501247812',
'371524198712133012',
'362402198803140010',
'371324198810092436',
'132201198410036618',
'370102198701214123',
'220204198704302714',
'370902198310202137',
'370103198304081570',
'370102197508313328',
'370102196507033338',
'370103197303304109',
'370902196605210012',
'372901197809143413',
'370111196506071013',
'370402197709187846',
'372922196910227715',
'110105196911094133',
'370902197006010072',
'370103197103126045',
'370121197507057712',
'370112197110267715',
'372929197007020047',
'370823197006051110',
'370102197409263759',
'370523197504150334',
'130603196506150910',
'370102196508253332',
'110108196504019039',
'37243019731029302X',
'37072419740113032X',
'37250119740426117X',
'372925197012113111',
'372425196910229413',
'42010619651019487X',
'370302196902260515',
'37010519621022233X',
'370102196502071327',
'370123197403290029',
'370111196603191076',
'370102196510273391',
'372926197710144835',
'43010319670418105X',
'370121197602157586',
'370103197402010018',
'372802197104120052',
'370102196908042972',
'37010519681226211X',
'370102196710203339',
'370920197004290034',
'370105197012143328',
'230103197106110312',
'430103197011241114',
'372801197303071218',
'370102196603203317',
'370102197511200017',
'370823197403250017',
'370723197304173110',
'372401196710282219',
'370103197412233514',
'31011019650905043X',
'370102196512293310',
'320102196801242895',
'370104197009100013',
'370102197012193318',
'372832197501270028',
'370103197202039334',
'370102197206063327',
'370303196904041734',
'372801196912112113',
'370103197903091514',
'370682198004040462',
'220204196809042155',
'370105197212123743',
'370102196805013335',
'370121197209181520',
'370103197108112523',
'222301197407271513',
'372421197010300068',
'370103197409035015',
'370103196505040514',
'370103196610120532',
'370102197404162510',
'379002197411032215',
'370102197409243352',
'372321197902188950',
'370303197903182513',
'370722197902236410',
'370112198211217412',
'370102197007130312',
'370627197408230212',
'61010319740216245X',
'310112196809300077',
'370105197201083731',
'370103196607070511',
'370102197010303317',
'370102197104222518',
'370303197404102515',
'370302198512155129',
'372432198812055010',
'370402198505291013',
'370103198708221023',
'370125198802130011',
'370681198801252250',
'152123198904204323',
'370902198703261824',
'371082198701230710',
'37040219851124191X',
'370323198710080211',
'371502198607101133',
'370103198801171542',
'372325198703290047',
'370102198005213311',
'371202198110247114',
'370103198610270513',
'230103198010020325',
'371121198610012315',
'370784198809010330',
'370102198103084525',
'412725198806267012',
'320623198806148097',
'320321198806094210',
'371425198112040032',
'41122219850329151X',
'150426197402120030',
'371322198002270553',
'370105198211131113',
'370829198810053590',
'370982198904294392',
'372526198004175338',
'371082198205044919',
'130402198508140013',
'37010319700420401X',
'370104197812210713',
'370282197910300047',
'370303196503070016',
'370102196507243319',
'370102196506243376',
'37010519711206001X',
'370105197406192122',
'370102197908073319',
'652801198105256117',
'370105197901071715',
'370102196912062538',
'371202198501167429',
'370104196406260358',
'370104197603112922',
'37010419721024035X',
'370102196607293313',
'37142519811118013X',
'370622197212051413',
'370783197901163590',
'370902198111251518',
'372425197903062074',
'610522197905078015',
'371302198101260419',
'370602198201162926',
'370725198712080236',
'37088319861102623X',
'370921198603041516',
'370784198310078213',
'372929198602170634',
'371327198808200230',
'371425198708205571',
'131102198603070230',
'320324198508140011',
'370126198809010094',
'370783198404230371',
'371082198803207730',
'370303198809240048',
'370724198609231853',
'370782198410162030',
'370982198509100631',
'370303198303251313',
'370686198504291714',
'37078319830711597X',
'370304198811240617',
'370602198903021343',
'370123198410064710',
'370882198705171212',
'371402198303082644',
'370285198110110011',
'370983198612013276',
'411422198712084219',
'150402198908062310',
'370502198507206033',
'430903198902081546',
'370104198410230310',
'371102198406195418',
'34262319870826687X',
'371102198710260616',
'371122198906281537',
'370781199001218214',
'370103198807024017',
'370781198110084839',
'370983198705141015',
'370782198501047214',
'370111197008182014',
'370111196708252058',
'370125196705170055',
'370102198509164111',
'370283198606067018',
'371322198607290012',
'371302198705253738',
'371327198301034317',
'370828199002107034',
'370802198801083616',
'370786198806105118',
'37142519890914009X',
'371482198507110346',
'371426198701292015',
'370104198804032624',
'371522198801215754',
'371524198803164914',
'370982198803131818',
'370522198201280033',
'371322199005240573',
'370683198010290034',
'370481198803132614',
'370883198904045354',
'370104196910120311',
'370982198711254976',
'370802198705023314',
'370802198905253624',
'371502199103242017',
'371426198807165639',
'37090219821027001X',
'370811198701100040',
'370786198812295413',
'371322199009140422',
'370703198802170536',
'371502199006102039',
'371321199007187933',
'370921198509133334',
'370402199003060033',
'372926198807053950',
'372324198512224120',
'370103198907201527',
'370682198709138611',
'239005198909294653',
'371402198611075737',
'370724198903052055',
'370685198611052210',
'370983199002250017',
'370921198608014234',
'370102198611150330',
'372930198802295998',
'370983198612271814',
'370285198705032913',
'370611198604010341',
'371526198602182836',
'37131119900505443X',
'371326198411234321',
'371327198604236418',
'370303198902165185',
'371002199010117017',
'370725198506113279',
'37150219870903033X',
'370104198705054529',
'371422198711200078',
'22060319880320033X',
'371328198603190071',
'370685198801060043',
'412828199002150037',
'370829198201154230',
'370783198308172319',
'410882199009201024',
'370103198909247529',
'372930198910135158',
'372928198702121067',
'370683198211177214',
'372330198111160055',
'370783198208202912',
'360102197312195823',
'410922199010101329',
'37078119940414052X',
'371328199106182534',
'370283199010124530',
'370902199012240922',
'371202198902184019',
'370683199003319235',
'370102198803093318',
'371121198911202315',
'370602199101155213',
'370322199010266718',
'220381199203160263',
'372928199010220018',
'371327199109084124',
'372301199109130722',
'130429199012172657',
'370782199204021151',
'370983199108151834',
'370523199107100017',
'370103199001010534',
'370104199302271320',
'371323199104107619',
'37142819920626054X',
'370404199202271418',
'371427199204265519',
'37132419920401941X',
'370705199201110519',
'370102199012174116',
'430423197403239015',
'370102196503283452',
'370481199106170636',
'142126197210054239',
'622425197410160313',
'330106197010120455',
'430626197207234831',
'370202199404061423',
'370827198809103519',
'371102199006087519',
'370785198512270912',
'37152219881119001X',
'370911198902232504',
'371523198411160096',
'371323198812250817',
'370982198903140658',
'370983198809187069',
'130429198705101216',
'500101198603161011',
'422822198707301017',
'37032319870813345X',
'370783198807202762',
'370102199012184146',
'372301199002060031',
'370828198612044021',
'370881198806135310',
'372301198801170021',
'130430198612031912',
'13068119870724361X',
'370126198911090414',
'370685198901266516',
'640202199105160013',
'371002199009208851',
'371323198808292133',
'370402199306287729',
'370921199003133614',
'610527198910033280',
'410782198910082793',
'371481198804027534',
'371311198902102337',
'370828198802262337',
'370522198605151318',
'370725199111120217',
'372323198904282112',
'370724199204157661',
'350481198910274016',
'370103198904054015',
'370103198810152511',
'370403198902065614',
'371102199104050031',
'372922199004210018',
'370781199011143631',
'370982198905227693',
'370724198811263912',
'370784198901158610',
'370830199012127217',
'371422199211161943',
'370724199211251410',
'370782198908108218',
'370724198705196146',
'370634198909010021',
'370685199002204017',
'371402199304271927',
'37148219900211141X',
'370104198905200316',
'370983199108252328',
'511623198910180536',
'370785199109200919',
'370781199005020520',
'370523199003040312',
'370302199310096911',
'370724198806070390',
'430725199006056010',
'370282198912281518',
'140104197112251618',
'310112197206290070',
'370102196706063310',
'371321199710098510',
'371102199511075711',
'370103195707190516',
'370402195803091016',
'370421196301030639',
'370602195312312313',
'370211195902140026',
'371424196204160036',
'372501196305270711',
'370502195502031234',
'372901195801111215',
'372901195704110835',
'37090219641202001X',
'370802196208100332',
'372401196211052734',
'370303196412191015',
'372901196301030835',
'370602196001220221',
'370702196401240315',
'370302196312030533',
'37011119630216105X',
'370111195904301035',
'370104196402291616',
'370902196305271833',
'370103196312060551',
'370304195801071318',
'370111195711011613',
'370102195310182917',
'372801195610231024',
'370102196908171328',
'370121195710087715',
'370102195412220822',
'370102195309080817',
'370111196408101047',
'370103196402040511',
'370102196208161348',
'370102196006081315',
'370104196410060359',
'370421195111080913',
'370102196007110026',
'370104196401170345',
'370103195305140532',
'370103196203250516',
'370111196203011013',
'37010319571225051X',
'370802195503142418',
'370721195907100779',
'370104196409031614',
'372901195601040811',
'370103195808080519',
'370103195109040534',
'370104195907150312',
'370102195705201916',
'37280119610319231X',
'370111195205124439',
'370103195111280510',
'370111195211141016',
'370111196301211676',
'370102196006011317',
'370104195512260330',
'370111195709071094',
'370103195409292012',
'370103196301030533',
'370104195507232917',
'372801195509021217',
'110108196205152796',
'372801196208201219',
'370111196411162019',
'370103195607134031',
'370111196308281036',
'370111196310251047',
'370102196906213328',
'370502195506141211',
'370103195012130517',
'370802195110070310',
'370103196304120526',
'370111195012031615',
'370402196411251222',
'370111195509081028',
'370103195509212542',
'370704196405130247',
'370104195206020312',
'370105195201113313',
'370103196812094045',
'370111195010032315',
'370103195511063515',
'370103196308230538',
'370102196203282917',
'370104195511110314',
'370104196808181644',
'370111196410111033',
'370902196103031233',
'370121196508107713',
'370103196210200517',
'370111195307181098',
'37011119640720161X',
'370104196301011611',
'370111196012061034',
'37280119640911121X',
'370103195207171036',
'37012119531101771X',
'372801194912011217',
'370111195802191664',
'370121196407037728',
'370111196107121036',
'370522196005022310',
'370825196408065337',
'370104196504161927',
'370705195010133015',
'370111196203061010',
'370632195609250019',
'370902195107191512',
'372801195010061236',
'370825196404215334',
'372802196412230013',
'310110196812130440',
'370105195301072117',
'370704195110120215',
'370104196204280342',
'370103195201060538',
'370102196304293391',
'370103196403070536',
'230103196409140637',
'37010319641016053X',
'370103196211210530',
'370111196410041039',
'370102195906302940',
'370103195112180511',
'370103196408280516',
'370103196206200514',
'370103196212060570',
'37010319630428351X',
'370102196912060620',
'370103196303140517',
'370103196104170510',
'370103196312090515',
'370103195411151032',
'370104196303312215',
'370102196407011318',
'370103196301040619',
'370103195407310512',
'370103195312050535',
'370103196208180510',
'370922196402152313',
'370104196901102621',
'370922195507152331',
'370104195804302918',
'370103196211144035',
'370102196312131325',
'370702196312120311',
'370303195603140013',
'370103196310160516',
'372801195507080010',
'370104196307280353',
'372801195705260418',
'37010319590530051X',
'370202196203255412',
'372801196404071212',
'370919195910132914',
'370802196612291521',
'370902196112211818',
'370402196007052512',
'370105196201093310',
'372301196302130333',
'370602196409282952',
'370103196301100511',
'372801196406171217',
'370104196308161639',
'370102196412053395',
'371327196609180012',
'370104196308280312',
'370103196310250538',
'370402195507252516',
'37030419570228131X',
'370111196202081028',
'370104195707012636',
'370402195809101211',
'370303195104133118',
'370103194412251516',
'370825194610195312',
'370502195510031226',
'370103195508130561',
'370103196310080540',
'370111195307104439',
'370102194906192935',
'370103195302250517',
'370103195302102012',
'370111194904281017',
'370111195512161627',
'370104193707021613',
'37011119350906101X',
'370103195302285517',
'370181193603132135',
'370802195602180321',
'370103193505260521',
'370103195402250522',
'370802194907151818',
'370103195403174023',
'370103195408120526',
'370103195312190562',
'370103194811260516',
'370104195309111620',
'370111194812271014',
'370111194808251010',
'370104194810112956',
'370104194806081018',
'370103195307304027',
'370103195305120523',
'370922195309112320',
'370102194809180334',
'370103194701312039',
'370305194705161817',
'370103195111200541',
'370111195209301025',
'370103194703070539',
'370103194712100533',
'370103194702160014',
'370802194705020318',
'370105194709180010',
'370105194606052112',
'370103195302274527',
'370104195303081627',
'370103195302020543',
'370104194512250314',
'372301195211140320',
'370702194508210336',
'37020219470621391X',
'370103195207130568',
'370104194707032915',
'370729194704080014',
'370102194910270617',
'370103195201170526',
'370105195202022122',
'370103195201180521',
'370802194703222119',
'370104194708250316',
'370111194706121012',
'370111194706291011',
'370402194512191012',
'37011119460507101X',
'370402194607291016',
'370104194310251319',
'370105194602092117',
'370103195101220522',
'370103194601270513',
'370103194602030511',
'370103194608140519',
'370111194611244415',
'370103194611110513',
'370103195111150548',
'372801194408200414',
'370104194612090012',
'37011119441001105X',
'370103194505210510',
'370104194608242618',
'370103194503151510',
'370105194507122111',
'370105194509232111',
'370104194505220352',
'370103194510300019',
'370922194410112312',
'370104194907262926',
'370103194404170011',
'370103194910020526',
'370421194211230611',
'370104194208071610',
'370111194305201011',
'370103194308162513',
'370105194302140017',
'370105194212112135',
'370104194807291623',
'370704194210190216',
'370103193312040514',
'370103193208261034',
'370111194504241024',
'370104193710032911',
'370103193512201028',
'370103193911020523',
'370102193906133324',
'370103193812100536',
'370103193709240514',
'370702193907310022',
'370103193703041020',
'370103194307301526',
'37010319380914401X',
'370111193909291033',
'370111193711101038',
'370103193508190522',
'370103193312070510',
'370802194312151827',
'370103193102110529',
'370103193509010511',
'370103193603021532',
'370103193310210516',
'370102193606162529',
'370103193106160515',
'370104193904082933',
'370802193408211826',
'370103193610180515',
'370103193404260514',
'370104194009251619',
'370205193310015540',
'370103193611070529',
'370104193804261619',
'370104193502161612',
'370103193709260515',
'370103193111170523',
'370103193806170538',
'370104193707151610',
'370103194011060532',
'370103193911100515',
'370103194009230512',
'370103193901280516',
'370103193811120527',
'370104193508231618',
'370103193409290528',
'370105194002251129',
'370111193612161019',
'370105193503192118',
'370103193911260017',
'370103194004270523',
'370103193904120518',
'370103193801260518',
'370103193701200526',
'370802194511221824',
'370103193708220511',
'370103194510190526',
'370103194012220518',
'370111193808251032',
'37010319361125052X',
'370103194011101015',
'370102193011101129',
'370102193512180814',
'37010219390710295X',
'370103193808161010',
'37010319370626051X',
'370103194106094022',
'370103194212110532',
'370103194207200517',
'370103194204301013',
'370103194110150517',
'370103194110100536',
'370103194709290524',
'370103194512180516',
'370103194505040515',
'370103194112222019',
'370103193208081519',
'370103195711160520',
'370104194203211629',
'370104194107012910',
'370104194612021623',
'370111193206291010',
'370702194701140341',
'370121195106057720',
'370111195701234442',
'370111195606034426',
'370111194102034436',
'370111194003024419',
'370111194410151036',
'370802194407251812',
'370105194007132110',
'370103195211030519',
'370103195308241531',
'370104194905222912',
'370103195810090521',
'370802194810191813',
'370111194902011611',
'370103195403080529',
'37010419481006291X',
'370102195404130624',
'370102194601202549',
'370102195806110618',
'370103195407234513',
'372801195809271218',
'370103195409228010',
'37011119541004231X',
'370111195502201031',
'370825196007205327',
'372801196012260428',
'370825195203185314',
'370111195812111015',
'370111196311041017'
)
group by  alr.ACCEPT_NUM
"""


# def execute_data(sql_query, excel_filename):
#     with DatabaseConnection() as db:
#         df = db.execute_query_to_dataframe(sql_query)
#         # 检查DataFrame是否为空
#         if df.empty:
#             #print("没有找到符合条件的数据记录。")
#             return None
#         else:
#             # 如果有数据，将其保存到Excel文件中
#             df.to_excel(excel_filename, index=False)
#             return df

# def send_weekly_report_email(seven_days_ago, yesterday,excel_filename):
#     # 配置邮件信息
#     email_config = {
#         'sender': 'messages-noreply@insuresmart.com.cn',
#         'password': 'M&H@&2z9E65q',  # SMTP授权码
#         'recipients': ['cuisl@insuresmart.com.cn','tkyl@insuresmart.com.cn'],
#         'smtp_server': 'smtp.exmail.qq.com',
#         'smtp_port': 465
#     }
#
#     # 创建EmailSender实例
#     sender = EmailSender(
#         email_config['sender'],
#         email_config['password'],
#         email_config['recipients'],
#         email_config['smtp_server'],
#         email_config['smtp_port']
#     )
#
#     # 构造邮件内容
#     subject = '本部补医报销服务监管统计表周报'
#     message = f"各位老师好！\n\n 请查收 本部补医报销服务监管统计表{seven_days_ago} 至 {yesterday} 的进件量统计 ！\n\n"
#     message += "具体信息见附件：\n"  # 这里您可以添加查询结果或更详细的信息
#
#
#     # 发送带有附件的邮件
#     sender.send_email_with_attachment(subject, message, excel_filename)


def send_weekly_report_email(seven_days_ago, yesterday,excel_filename):
    # 配置邮件信息
    email_config = {
        'sender':'messages-noreply@insuresmart.com.cn',
        'password': 'M&H@&2z9E65q',  # SMTP授权码
        # 'recipients': ['cuisl@insuresmart.com.cn'],
        'recipients': ['cuisl@insuresmart.com.cn','tkyl@insuresmart.com.cn','dangrm@insuresmart.com.cn'],
        'smtp_server':'smtp.exmail.qq.com',
        'smtp_port': 465
    }

    # 创建EmailSender实例
    sender = EmailSender_New(
        email_config['sender'],
        email_config['password'],
        email_config['recipients'],
        email_config['smtp_server'],
        email_config['smtp_port']
    )

    # 构造邮件内容
    subject = '本部补医报销服务监管统计表周报'
    message = f"各位老师好！\n\n 请查收 本部补医报销服务监管统计表{seven_days_ago} 至 {yesterday} 的进件量统计 ！\n\n"
    message += "具体信息见附件：\n"  # 这里您可以添加查询结果或更详细的信息

    sender.send_email_with_attachment(subject, message, excel_filename)



def execute_data(sql_query,excel_filename):
    with DatabaseConnection() as db:
        df = db.execute_query_to_dataframe(sql_query)
        #print(df.head(3))
        #excel_filename = "E:\\pycharm\\output\\" + f"平安机构进件量_{formatted_date}.xlsx"
        #print(excel_filename)
        df.to_excel(excel_filename, index=False)

if __name__ == "__main__":
    # excel_filename = r"E:\pycharm\output\\" + f"本部补医报销服务监管统计表_{formatted_date}.xlsx"
    excel_filename = "/opt/adb_report/report_claim/output/" + f"本部补医报销服务监管统计表_{formatted_date}.xlsx"
    start_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print("程序开始时间：", start_time)
    # 执行SQL查询并获取结果
    execute_data(sql_query, excel_filename)
    # 根据查询结果发送邮件
    send_weekly_report_email(seven_days_ago, yesterday, excel_filename)
    end_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print("程序结束时间：", end_time)
